!function(t,e){"function"==typeof define&&define.amd?define(["jquery","backbone","underscore"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("backbone"),require("underscore")):t.backboneJsonApi=e(t.jQuery,t.Backbone,t._)}(this,function(d,n,l){var r,s,e;return e=n.Collection.extend({modelId:function(t){return t._type+"@"+t.id},retrieve:function(e,i){var t=this.find(function(t){return t.getType()===e&&t.get("id")===i});return t&&!t.includedCollection&&(t.includedCollection=this.clone()),t}}),s=n.Model.extend({constructor:function(t,e,i){this.apiData={data:{},included:[]},this.includedArray=[],(t=t||{}).id&&(this.apiData.data.id=t.id),this.type&&(this.apiData.data.type=this.type),t._type&&(this.apiData.data.type=t._type);var a=this.initialize;this.initialize=function(){},n.Model.call(this,t,e),i&&i.call(this,this),a.apply(this,arguments)},http:d,getType:function(){return this.apiData.data.type},setType:function(t){return this.apiData.data.type=t,this},unset:function(t){return"id"===t&&delete this.apiData.data.id,n.Model.prototype.unset.apply(this,arguments)},buildIncludedCollection:function(){if(!this.includedCollection){var t=l.map(this.includedArray,function(t){var e=s.createFromData({data:t},{assignIncludes:!1});return e.includedArray=this.includedArray,e},this);this.includedCollection=new e([this].concat(t)),this.sourceCollection&&this.sourceCollection.each(function(t){t.includedCollection=this.includedCollection.clone()},this)}return this},get:function(t){var e,i=l.isArray(t)?t:t.split("."),a=i[0];if(this.apiData.data.relationships&&this.apiData.data.relationships[a]){if(void 0!==(e=this.getRelation(a))){if(2===i.length&&e instanceof r)return e.pluck(i[1]);if(1<i.length)return i.shift(),e.get(i)}}else e=n.Model.prototype.get.call(this,a);return e},getRelation:function(t){var e=this.apiData.data.relationships[t],i=e&&e.data;return i?l.isArray(i)?(this.buildIncludedCollection(),new r(l.map(i,function(t){return this.includedCollection.retrieve(t.type,t.id)},this))):(this.buildIncludedCollection(),this.includedCollection.retrieve(i.type,i.id)):void 0},getRelationReferences:function(t){if(this.apiData.data.relationships&&this.apiData.data.relationships[t]){var e=this.apiData.data.relationships[t].data;return l.isArray(e)?e.length?l.pluck(e,"id"):void 0:e&&e.id?e.id:void 0}},setRelation:function(t,e){var i=this.apiData.data;return i.relationships=i.relationships||{},this.buildIncludedCollection(),l.each(l.isObject(t)?t:l.object([t],[e]),function(t,e){t instanceof s?(this.includedCollection.add(t,{merge:!0}),t={type:t.getType(),id:t.get("id")}):t instanceof r&&(this.includedCollection.add(t.models,{merge:!0}),t=t.map(function(t){return{type:t.getType(),id:t.get("id")}})),i.relationships[e]=i.relationships[e]||{},i.relationships[e].data=t},this),this},saveOnly:function(t){var e,i=this,a=this.preparePersistedKeys(t);return t.relations&&!l.isArray(t.relations)&&this.setRelation(t.relations),t.files&&(a.files=t.files),e=this.save(l.isArray(t.attributes)?null:t.attributes,a),t.afterSave&&e.done(function(){t.afterSave(i)}),e},saveAttribute:function(t,e){return void 0!==e&&this.set(t,e),this.saveOnly({attributes:[t]})},saveFile:function(t,e){if(void 0!==e){var i={};i[t]=e}else i=t;return this.saveOnly({files:i})},saveRelation:function(t,e){return e&&this.setRelation(t,e),this.saveOnly({relations:[t]})},preparePersistedKeys:function(t){var e={};return t.attributes?e.persistedAttributes=l.isArray(t.attributes)?t.attributes:l.keys(t.attributes):e.persistedAttributes=[],t.relations?l.isArray(t.relations)?e.persistedRelations=t.relations:e.persistedRelations=l.keys(t.relations):e.persistedRelations=[],e},prepareSyncData:function(t){var e=l.extend({},l.pick(this.apiData.data,["type","id"])),i=this.persistedAttributes||t.persistedAttributes,a=i?l.pick(this.attributes,i):this.attributes;a=l.omit(a,["id","_type"]),l.isEmpty(a)||(e.attributes=a);var n=this.persistedRelations||t.persistedRelations,r=n?l.pick(this.apiData.data.relationships,n):this.apiData.data.relationships;return l.isEmpty(r)||(e.relationships=r),t.files&&!l.isEmpty(t.files)&&(e.files=t.files),e},sync:function(t,e,i){var a={type:{create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"}[t],dataType:"json",url:l.result(e,"url"),processData:!1};if(!i.data&&e&&("create"===t||"update"===t||"patch"===t)){var n=this.prepareSyncData(i);if(n.files){var r=new FormData;r.append("data",JSON.stringify(l.omit(n,"files"))),l.each(n.files,function(t,e){r.append(e,t)}),l.extend(a,{type:"POST",contentType:!1,data:r})}else l.extend(a,{contentType:"application/vnd.api+json",data:JSON.stringify({data:n})})}var s=i.xhr=this.http.ajax(l.extend(a,i));return e.trigger("request",e,s,i),s},urlRoot:function(){return"/api/"+this.getType()},parse:function(t,e){l.extend(this.apiData,t);var i=t.data.attributes||{};return t.data.id&&(i.id=t.data.id),t.data.type&&(i._type=t.data.type),delete this.includedCollection,this.includedArray=[t.data].concat(t.included||[]),i}},{apiUrl:function(t,e){return"/api/"+t+(e?"/"+e:"")},getType:function(){return this.prototype.type},getFromApi:function(t,i,a){t=l.extend({resourceName:this.type},t);var n=this,e=n.prototype.http,r=t.resourceName||t.type||n.getType(),s=t.url||n.apiUrl(r,t.id),o=d.Deferred();return e.get(s,function(t){var e=n.createFromData(t);i&&i.call(a||this,e,t),o.resolve(e)}).fail(function(t){o.reject(t)}),o},createFromData:function(e,i){e.data=e.data||{},i=l.extend({assignIncludes:!0},i);var t=e.data.attributes||{};return e.data.id&&(t.id=e.data.id),e.data.type&&(t._type=e.data.type),new this(t,i,function(t){l.extend(t.apiData,e),i.assignIncludes&&(t.includedArray=[e.data].concat(e.included||[]))})},create:function(t,e){return new this(t,e)}}),r=n.Collection.extend({fetch:function(){return r.getFromApi({url:this.url||this.apiUrl},function(t){this.set(t.models)},this)},http:d},{apiUrl:function(t,e){return"/api/"+t},getFromApi:function(i,a,n){"string"==typeof i&&(i={resourceName:i});var r=this,t=r.prototype.http,s=i.url||r.apiUrl(i.resourceName||i.type,i),o=d.Deferred();return t.get(s,function(t){var e=r.createFromData(t,i);e.apiUrl=s,a&&a.call(n||this,e,t),o.resolve(e)}).fail(function(t){o.reject(t)}),o},createFromData:function(t,e){var i=e&&e.Model||s,a=t.data.concat(t.included||[]),n=new this(l.map(t.data,function(t){var e=i.createFromData({data:t},{assignIncludes:!1});return e.includedArray=a,e}),e);return n.each(function(t){t.sourceCollection=n}),n.apiData=t,n}}),{Model:s,Collection:r}});